#!/usr/bin/env bash
# Push remote-only branch using top-line summary of most recent commit.
#
# Projects with trunk-based development and code review on each merge end up
# with short incremental changes as the project becomes stable. In this state,
# work is done in the trunk/mainline branch, but instead of pushing directly,
# push to a branch to serve as source to a pull request or code review.
#
# Generally, after issuing `git quick-push`, with the new branch safely pushed
# to the remote, issue a `git reset --hard` on the upstream branch to continue
# development.

git_quick_push_name() {
    # Print name of new branch using top-line summary of most recent commit.

    echo -n "${GIT_QUICK_PREFIX}"
    git log --pretty=format:%s -n 1 |\
        head -1 |\
        tr '[:upper:]' '[:lower:]' |\
        sed -e 's/[ _]/-/g' |\
        sed -e 's/[^A-Za-z0-9_-]//g'
    echo
}

git_quick_push() {
    # Push remote-only branch.

    local current remote
    remote="${GIT_QUICK_REMOTE:-origin}"

    current=$(git symbolic-ref HEAD 2>/dev/null | cut -d/ -f3-)
    if [ -z "$current" ]; then
        echo "error: not on any branch." >&2
        return 1
    fi

    git push "$remote" "$current":"$(git_quick_push_name)"
}

main() {
    if [ "$1" = "--name" ]; then
        shift
        git_quick_push_name "$@"
    else
        git_quick_push "$@"
    fi
}

main "$@"
