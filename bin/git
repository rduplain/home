#!/bin/bash
# Wrap `git` to use .homegit.

use_homegit() {
    [ -n "$USE_HOMEGIT" ] || [ -d .homegit ] && ! [ -d .git ]
}

main() {
    DIR="$( cd -P "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
    . "$DIR"/wrapper.bash

    if requested_only _source "$@"; then
        # Make `. git _source` available to pull in functions.
        return 0
    fi

    git="$(set_aside_this_and_find_that "$DIR" git)"

    if [ -z "$git" ]; then
        # No other `git` found.
        return 2
    fi

    cmd="$git"

    if use_homegit && ! requested clone "$@"; then
        cmd="$git --git-dir=$HOME/.homegit --work-tree=$HOME"
    fi

    if requested_only sync "$@"; then
        $cmd fetch &&
            $cmd rebase --committer-date-is-author-date origin/master
    else
        exec $cmd "$@"
    fi
}

main "$@"
