#!/usr/bin/env bash
# Install `opam` for OCaml development.

OPAM="$REQD_OPT"/ocaml/bin/opam
OPAM_URL=https://github.com/ocaml/opam

check() {
    reqd_ls "$OPAM"
    reqd_run_once
}

install() {
    rm -f "$OPAM"

    qwertyrc > opam.qwertyrc
    "$REQD_BIN"/qwerty.sh --rc opam.qwertyrc
    "$OPAM" --version

    "$OPAM" init --yes --auto-setup --disable-shell-hook --reinit

    # $HOME git (.homegit) tracks opam setup files.
    # When user-setup is needed, use the following.
    #
    # "$OPAM" --yes user-setup install
}

qwertyrc() {
    cat - <<EOF
# GNU/Linux x86_64
  --sys=linux --arch=x86_64 \\
  --sha256=10c8def09368da9d2d6a6951363892fef117e168b2a4f8d288f366fe4140d01e \\
  --output="$OPAM" --chmod=755 \\
  $OPAM_URL/releases/download/2.1.0/opam-2.1.0-x86_64-linux

# GNU/Linux ARM
  --sys=linux --arch=arm --all-sub-arch \\
  --sha256=0f002834157d00f074f7ed6d7ff43e2309c6522618edc7b1ab62693cd4aa6b7f \\
  --output="$OPAM" --chmod=755 \\
  $OPAM_URL/releases/download/2.1.0/opam-2.1.0-armhf-linux

# macOS x86_64
  --sys=darwin --arch=x86_64 \\
  --sha256=6aaa4b4bcfdffe849dc051c1094ac2d40c56567d8eadefe22f6c8ab616f7027c \\
  --output="$OPAM" --chmod=755 \\
  $OPAM_URL/releases/download/2.1.0/opam-2.1.0-x86_64-macos
EOF
}

reqd_main "$@"
